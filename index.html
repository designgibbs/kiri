<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kiri:Moto Headless Slicer</title>
</head>
<body>
<script type="module">
  import { KIRI } from 'https://grid.space/code/kiri.js';

  // Initialize KIRI with your GitHub Pages as baseURL to load wasm locally
  const kiri = new KIRI({
    baseURL: 'https://designgibbs.github.io/',  // your GitHub Pages root URL
    mode: 'FDM',
    config: {
      device: {
        bedWidth: 256,
        bedDepth: 256,
        bedHeight: 256,
        nozzle: 0.4,
        filament: 1.75
      },
      base: {
        stock: { x: 256, y: 256, z: 256, center: true }
      },
      process: {
        sliceHeight: 0.2,
        sliceShells: 3,
        sliceFillSparse: 0.15,
        sliceFillType: 'hex',
        sliceSupportEnable: false
      },
      print: {
        printSpeed: 60,
        retractionSpeed: 25
      }
    }
  });

  window.addEventListener('message', async (event) => {
    if (!event.data || !event.data.stl) return;

    try {
      // Decode base64 STL string to Uint8Array
      const decoded = Uint8Array.from(atob(event.data.stl), c => c.charCodeAt(0));

      // Load STL model into KIRI
      await kiri.api.load({ name: 'model.stl', array: decoded });

      // Run slicing process
      await kiri.api.slice();

      // Export print statistics
      const stats = kiri.api.export();

      // Send results back to parent window
      parent.postMessage({
        printTime: Math.ceil(stats.time / 60),  // convert seconds to minutes, rounded up
        grams: stats.weight.toFixed(1)          // filament weight in grams with 1 decimal
      }, '*');

    } catch (err) {
      // Send error message back to parent window
      parent.postMessage({ error: err.message }, '*');
    }
  });
</script>
</body>
</html>
