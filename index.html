<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kiri Headless Slicer</title>
  <script src="https://grid.space/code/kiri.js"></script>
</head>
<body>
<script>
  function initKiri() {
    if (!window.kiri) {
      setTimeout(initKiri, 50);
      return;
    }
    kiri.init({
      baseURL: 'https://designgibbs.github.io/',
      mode: 'FDM',
      config: {
        device: { bedWidth: 256, bedDepth: 256, bedHeight: 256, nozzle: 0.4, filament: 1.75 },
        base: { stock: { x: 256, y: 256, z: 256, center: true } },
        process: { sliceHeight: 0.2, sliceShells: 3, sliceFillSparse: 0.15, sliceFillType: 'hex', sliceSupportEnable: false },
        print: { printSpeed: 60, retractionSpeed: 25 }
      },
      onready: () => {
        window.addEventListener('message', async (event) => {
          if (!event.data || !event.data.stl) return;
          try {
            const decoded = Uint8Array.from(atob(event.data.stl), c => c.charCodeAt(0));
            await kiri.api.load({ name: 'model.stl', array: decoded });
            await kiri.api.slice();
            const stats = kiri.api.export();
            parent.postMessage({
              printTime: Math.ceil(stats.time / 60),
              grams: stats.weight.toFixed(1)
            }, '*');
          } catch (e) {
            parent.postMessage({ error: e.message }, '*');
          }
        });
      }
    });
  }
  initKiri();
</script>
</body>
</html>
