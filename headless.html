<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kiri:Moto Headless</title>
  <script>
    console.log("âœ… Headless Kiri:Moto Loaded");
    window.addEventListener("message", async (event) => {
      if (!event.data || !event.data.stl) return;

      console.log("ðŸ“¦ STL received from parent");
      const base64 = event.data.stl;
      const binary = Uint8Array.from(atob(base64), c => c.charCodeAt(0));

      // Load Kiri:Moto
      if (typeof KIRI === "undefined") {
        await import('./kiri.js'); // Local copy from GitHub Pages
      }

      const device = KIRI.driver.FDM;
      const settings = KIRI.conf(); // get default config
      const proc = settings.process;
      const mode = settings.mode;

      // Apply Bambu P1S 0.20mm profile
      mode.device = "FDM";
      mode.mode = "FDM";
      mode.sproc = "bambu-p1s";
      proc.sliceHeight = 0.20;
      proc.sliceShells = 2;
      proc.sliceFillSparse = 0.15;
      proc.sliceSpeedPrint = 60;
      proc.sliceSupportEnable = true;

      console.log("âš™ï¸ Slicing started...");
      const widgets = KIRI.codec.decode(binary.buffer);
      KIRI.platform.clear();
      widgets.forEach(w => KIRI.platform.add(w));
      await KIRI.slice();

      const stats = KIRI.platform.stats();
      const timeMinutes = Math.round(stats.time / 60);
      const grams = Math.round(stats.weight);
      const meters = (stats.filament / 1000).toFixed(2);

      console.log("âœ… Slicing complete");
      parent.postMessage({ printTime: timeMinutes, grams, meters }, "*");
    });
  </script>
</head>
<body>
</body>
</html>
