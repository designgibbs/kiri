<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Headless Kiri:Moto</title>
</head>
<body>
<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';
  window.THREE = THREE;  // expose THREE globally for kiri.module.js

  import("https://grid.space/code/kiri.module.js").then(({ KIRI }) => {
    console.log("‚úÖ Headless Kiri:Moto Loaded");

    const engine = KIRI.newEngine();
    engine.sync();

    window.addEventListener("message", async (event) => {
      const file = event.data;
      if (!(file instanceof File)) {
        console.log("Ignoring message: not a File");
        return;
      }

      console.log("üì• Received STL file:", file.name);

      try {
        const buffer = await file.arrayBuffer();

        // Bambu P1S .20mm standard print profile settings (approx)
        const settings = {
          process: {
            sliceHeight: 0.2,
            sliceShells: 2,
            sliceTopLayers: 5,
            sliceBottomLayers: 5,
            sliceFillSparse: 15,  // 15% infill
            sliceFillType: "hex",
            sliceSupportEnable: false
          },
          device: {
            bedWidth: 256,
            bedDepth: 256,
            bedHeight: 256,
            extrudeFilament: 1.75,
            nozzle: 0.4
          },
          processName: "bambu-0.20mm-standard"
        };

        console.log("üßÆ Starting slicing...");
        const result = await engine.sliceFile(buffer, settings);

        const stats = result.stats || {};
        const printTimeMin = (stats.printTime || 0).toFixed(1);
        const filamentMeters = ((stats.filament || 0) / 1000).toFixed(2);

        console.log(`‚úÖ Slicing done. Time: ${printTimeMin} min, Filament: ${filamentMeters} m`);

        parent.postMessage(
          {
            printTimeMinutes: printTimeMin,
            filamentMeters: filamentMeters,
            stats: stats
          },
          "*"
        );
      } catch (error) {
        console.error("‚ùå Error slicing STL:", error);
        parent.postMessage({ error: error.message }, "*");
      }
    });
  }).catch(e => {
    console.error("‚ùå Failed to load Kiri:Moto module:", e);
  });
</script>
</body>
</html>
