<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Kiri:Moto Headless</title>
  </head>
  <body>
    <script type="module">
      console.log("âœ… Headless Kiri:Moto Loaded");

      import("https://grid.space/code/kiri.module.js").then(({ KIRI }) => {
        console.log("ðŸ§  KIRI module loaded");

        const engine = KIRI.newEngine();
        engine.sync();

        window.addEventListener("message", async (event) => {
          const file = event.data;
          if (!(file instanceof File)) return;

          console.log("ðŸ“¥ STL file received:", file.name);

          const buffer = await file.arrayBuffer();

          const settings = {
            process: {
              sliceHeight: 0.2,
              sliceShells: 2,
              sliceTopLayers: 5,
              sliceBottomLayers: 5,
              sliceFillSparse: 15,
              sliceFillType: "hex",
              sliceSupportEnable: false
            },
            device: {
              bedWidth: 256,
              bedDepth: 256,
              bedHeight: 256,
              extrudeFilament: 1.75,
              nozzle: 0.4
            },
            processName: "bambu-0.20mm-standard"
          };

          console.log("ðŸ§® Slicing started...");

          const result = await engine.sliceFile(buffer, settings);

          const { stats } = result;
          const minutes = (stats.printTime || 0).toFixed(1);
          const meters = ((stats.filament || 0) / 1000).toFixed(2);

          console.log(`âœ… Slicing complete: ${minutes} min, ${meters} m`);

          parent.postMessage(
            {
              printTimeMinutes: minutes,
              filamentMeters: meters
            },
            "*"
          );
        });
      });
    </script>
  </body>
</html>
