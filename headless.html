<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kiri:Moto Headless - Bambu .20mm Standard</title>
</head>
<body>
<script type="module">
  import { KIRI } from 'https://grid.space/code/kiri.module.js';

  console.log('Headless Kiri:Moto Loaded');

  // Initialize KIRI instance
  const app = new KIRI();

  // Bambu P1S .20mm standard profile (adjust params as needed)
  const bambuProfile = {
    printer: 'bambu_p1s',
    layerHeight: 0.20,
    printSpeed: 60,
    filamentDiameter: 1.75,  // mm
    filamentDensity: 1.24,   // g/cm3 for PLA
    infillDensity: 0.15
  };

  app.set('printer', bambuProfile.printer);
  app.set('slice', {
    layerHeight: bambuProfile.layerHeight,
    printSpeed: bambuProfile.printSpeed,
    infillDensity: bambuProfile.infillDensity,
    filamentDiameter: bambuProfile.filamentDiameter,
    filamentDensity: bambuProfile.filamentDensity
  });

  app.start();

  window.addEventListener('message', async (event) => {
    if (!event.data?.stl) return;
    try {
      const base64 = event.data.stl;
      const binaryStr = atob(base64);
      const len = binaryStr.length;
      const buffer = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        buffer[i] = binaryStr.charCodeAt(i);
      }

      app.clear();
      app.addPart(buffer.buffer, { filename: 'upload.stl' });

      await app.slice();

      const stats = app.stats || {};

      // filament grams
      const grams = stats.filament || 0;

      // filament length in meters = volume (cm3) / cross-sectional area (cm2)
      const density = bambuProfile.filamentDensity;
      const diameterMM = bambuProfile.filamentDiameter;
      const radiusCM = (diameterMM / 2) / 10;
      const volumeCM3 = grams / density;
      const lengthM = volumeCM3 / (Math.PI * radiusCM * radiusCM);

      window.parent.postMessage({
        printTime: Math.round(stats.time || 0),  // seconds
        filamentGrams: grams.toFixed(1),
        filamentMeters: lengthM.toFixed(2)
      }, '*');

    } catch (err) {
      console.error('Error slicing:', err);
      window.parent.postMessage({ error: err.message }, '*');
    }
  });
</script>
</body>
</html>
