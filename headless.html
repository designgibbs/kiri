<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8" /><title>Headless Kiri:Moto</title></head>
<body>
<script src="https://grid.space/code/kiri.js"></script>
<script>
  console.log("BAMBU MODULE RUNNING");

  // Wait for kiri to be ready
  setTimeout(() => {
    if (!kiri) {
      console.error("Kiri:Moto not loaded");
      return;
    }

    console.log("âœ… Headless Kiri:Moto Loaded");

    kiri.mode('slice');
    kiri.sync();

    window.addEventListener("message", async (event) => {
      const file = event.data;
      if (!(file instanceof File)) {
        console.log("Ignoring non-file message");
        return;
      }
      console.log("Received STL file:", file.name);

      try {
        const buffer = await file.arrayBuffer();

        const settings = {
          process: {
            sliceHeight: 0.2,
            sliceShells: 2,
            sliceTopLayers: 5,
            sliceBottomLayers: 5,
            sliceFillSparse: 15,
            sliceFillType: "hex",
            sliceSupportEnable: false
          },
          device: {
            bedWidth: 256,
            bedDepth: 256,
            bedHeight: 256,
            extrudeFilament: 1.75,
            nozzle: 0.4
          },
          processName: "bambu-0.20mm-standard"
        };

        console.log("Slicing started...");
        const result = await kiri.sliceFile(buffer, settings);

        const stats = result.stats || {};
        const printTimeMin = (stats.printTime || 0).toFixed(1);
        const filamentMeters = ((stats.filament || 0) / 1000).toFixed(2);

        console.log(`Slicing done. Time: ${printTimeMin} min, Filament: ${filamentMeters} m`);

        parent.postMessage({
          printTimeMinutes: printTimeMin,
          filamentMeters: filamentMeters,
          stats: stats
        }, "*");

      } catch(e) {
        console.error("Error slicing STL:", e);
        parent.postMessage({ error: e.message }, "*");
      }
    });
  }, 1000);
</script>
</body>
</html>
