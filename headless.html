<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kiri:Moto Headless</title>
</head>
<body>
<script type="module">
  import { KIRI } from 'https://grid.space/code/kiri.module.js';

  console.log('Headless Kiri:Moto Loaded');

  const app = new KIRI();

  app.start();

  window.addEventListener('message', async (event) => {
    if (!event.data?.stl) return;

    try {
      const base64 = event.data.stl;
      const binaryStr = atob(base64);
      const len = binaryStr.length;
      const buffer = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        buffer[i] = binaryStr.charCodeAt(i);
      }

      app.clear();
      app.addPart(buffer.buffer, { filename: 'upload.stl' });

      await app.slice();

      const stats = app.stats || {};

      window.parent.postMessage({
        printTime: Math.round(stats.time || 0),
        filamentGrams: (stats.filament || 0).toFixed(1)
      }, '*');
    } catch (err) {
      console.error('Error slicing:', err);
      window.parent.postMessage({ error: err.message }, '*');
    }
  });
</script>
</body>
</html>
