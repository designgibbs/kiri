<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kiri:Moto Hidden Slicer</title>
  <style> body, html { margin:0; padding:0; height:100%; overflow:hidden; } #app { display:none; } </style>
</head>
<body>
  <div id="app"></div>

  <script src="https://grid.space/code/kiri.js"></script>
  <script>
    console.log('BAMBU MODULE RUNNING');

    const settings = {
      printer: 'bambu-p1s',
      profile: 'bambu-20-standard', // Adjust if needed
      units: 'mm',
      filamentDiameter: 1.75,
      layerHeight: 0.2,
      infillPercent: 15,
      printSpeed: 60
    };

    kiri.ready(() => {
      console.log('âœ… Headless Kiri:Moto Loaded');
      document.getElementById('app').style.display = 'none';

      window.addEventListener('message', async (event) => {
        if (!event.data || !event.data.type) return;

        if (event.data.type === 'slice-stl') {
          try {
            const { fileBuffer } = event.data;

            await kiri.sliceBuffer(fileBuffer, settings);

            const timeSec = kiri.time();
            const filamentMM = kiri.filament();
            const filamentM = filamentMM / 1000;

            window.parent.postMessage({
              type: 'slice-result',
              printTimeSeconds: timeSec,
              filamentMM,
              filamentM
            }, '*');
          } catch (e) {
            window.parent.postMessage({ type: 'slice-error', error: e.message }, '*');
          }
        }
      });
    });
  </script>
</body>
</html>
