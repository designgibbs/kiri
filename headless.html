<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kiri:Moto Headless Slicer</title>

<!-- Hide all UI -->
<style>
  html, body, #container, canvas, #kiri-top, #kiri-bottom, #kiri-left, #kiri-right {
    display: none !important;
  }
</style>

</head>
<body>

<div id="container"></div>

<script src="https://grid.space/code/kiri.js"></script>
<script>
  console.log("BAMBU MODULE RUNNING");

  // Wait for Kiri to be ready
  function waitForKiri() {
    return new Promise(resolve => {
      let tries = 0;
      (function check() {
        if (window.kiri && window.kiri.init) {
          resolve();
        } else if (tries++ < 100) {
          setTimeout(check, 50);
        } else {
          console.error("Kiri failed to load.");
        }
      })();
    });
  }

  async function run() {
    await waitForKiri();

    // Init Kiri in hidden UI mode
    kiri.init({
      mode: 'FDM', // FDM slicing mode
      profile: 'bambu20', // Custom profile name (we'll define)
      ui: false // Not showing UI (but we hide with CSS anyway)
    });

    // Add Bambu P1S 0.20mm standard profile
    kiri.conf.profile.bambu20 = {
      layerHeight: 0.20,
      nozzleSize: 0.40,
      printSpeed: 60,
      filamentDiameter: 1.75,
      filamentDensity: 1.24, // PLA approx g/cm3
      extrusionMultiplier: 1.0,
      travelSpeed: 150,
      infillDensity: 0.15,
      retractionDistance: 5,
      retractionSpeed: 40,
      nozzleTemp: 205,
      bedTemp: 60,
      // Other params can be added as needed
    };

    console.log("âœ… Headless Kiri:Moto Loaded");

    // Listen for STL file data from parent
    window.addEventListener("message", async (event) => {
      if (!event.data || event.data.type !== 'stl-file') return;

      try {
        console.log("Received STL file data, slicing...");

        // Load STL file as ArrayBuffer
        const fileBuffer = event.data.buffer;

        // Load the STL mesh into Kiri
        await kiri.open(fileBuffer);

        // Slice the model with bambu20 profile
        await kiri.slice({ profile: 'bambu20' });

        // After slicing, extract info
        const timeSeconds = kiri.getTime();
        const filamentMm = kiri.getFilament();

        // Convert filament length to meters
        const filamentMeters = filamentMm / 1000;

        console.log("Print time (seconds):", timeSeconds);
        console.log("Filament length (meters):", filamentMeters.toFixed(2));

        // Post results back to parent
        window.parent.postMessage({
          type: 'slice-result',
          timeSeconds,
          filamentMeters
        }, "*");

      } catch(e) {
        console.error("Error during slicing:", e);
        window.parent.postMessage({
          type: 'slice-error',
          message: e.message || e.toString()
        }, "*");
      }
    }, false);
  }

  run();
</script>

</body>
</html>
