<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Kiri:Moto Headless</title>
</head>
<body>
<script src="kiri.js"></script>
<script>
  console.log("âœ… Headless Kiri:Moto Loaded");

  window.KIRI?.ready(() => {
    const engine = KIRI.work;

    // Listen for file upload from Squarespace iframe
    window.addEventListener("message", async (e) => {
      const { type, file } = e.data || {};
      if (type !== "slice" || !file) return;

      const reader = new FileReader();
      reader.onload = async function (event) {
        const arrayBuffer = event.target.result;

        engine.init({
          platform: { x: 256, y: 256 }, // Bambu P1S default
          device: "FDM",
          mode: "FDM",
          fdm: {
            nozzle: 0.4,
            sliceHeight: 0.2,
            shellCount: 2,
            fillDensity: 0.15,
            fillType: "hex",
            printSpeed: 60,
            material: "PLA",
            filamentSize: 1.75,
            filamentDensity: 1.24
          }
        });

        const mesh = await KIRI.codec.stl.toObject(arrayBuffer);
        engine.slice([mesh], (data) => {
          const { stats } = data;

          // Calculate filament length in meters
          const mmLength = stats.filament || 0;
          const meters = (mmLength / 1000).toFixed(2);
          const minutes = Math.round(stats.time / 60);

          // Send result to parent
          parent.postMessage({
            type: "result",
            time: minutes,
            length: meters
          }, "*");
        });
      };

      reader.readAsArrayBuffer(file);
    });
  });
</script>
</body>
</html>
