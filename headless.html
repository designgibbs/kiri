<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kiri:Moto Headless Slicer</title>
  <script type="module">
    import { KIRI } from 'https://grid.space/code/kiri.js';

    let kiri;

    function setup() {
      // Init Kiri headless
      kiri = new KIRI();

      // Use Bambu Lab X1C standard 0.20mm print profile
      kiri.settings.set({
        slicer: 'slic3r', // default slicer engine
        layerHeight: 0.2,
        filamentDiameter: 1.75,
        nozzleDiameter: 0.4,
        printSpeed: 60,
        infillPercent: 15,
        retractionDistance: 5,
        materialDensity: 1.24 // PLA approx
      });
    }

    function base64ToBuffer(base64) {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    // Handle incoming STL from parent
    window.addEventListener('message', async (event) => {
      if (!event.data.stl) return;
      try {
        // Decode base64 STL file data
        const buffer = base64ToBuffer(event.data.stl);

        // Add model from buffer
        const model = await kiri.add(buffer, 'stl');

        // Slice model with current settings
        const result = await kiri.slice();

        // Extract print time (minutes) and filament used (grams)
        const timeMin = (result.time / 60).toFixed(1);
        const grams = (result.filament / 1000).toFixed(1);

        // Send results back to parent window
        window.parent.postMessage({ printTime: timeMin, grams }, '*');
      } catch (e) {
        window.parent.postMessage({ error: e.message }, '*');
      }
    });

    // Initialize on load
    window.onload = () => {
      setup();
      console.log('Headless Kiri:Moto Loaded');
    };
  </script>
</head>
<body></body>
</html>
