<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kiri:Moto Headless Bambu</title>
  <script src="https://grid.space/code/kiri.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #output { margin-top: 1em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Bambu Slicer (0.20mm)</h2>
  <input type="file" id="fileInput" accept=".stl">
  <div id="output"></div>

  <script>
    console.log("✅ Bambu UI-Hidden Kiri:Moto Running");
    let kiriLoaded = false;

    function estimateVolume(points) {
      // Convex hull estimate fallback if needed
      return 0;
    }

    function estimateFilament(volume_mm3) {
      const filamentDiameter = 1.75; // mm
      const filamentRadius = filamentDiameter / 2;
      const filamentArea = Math.PI * filamentRadius ** 2; // mm^2
      const filamentLength = volume_mm3 / filamentArea; // mm
      return filamentLength / 1000; // meters
    }

    function showOutput(text) {
      document.getElementById('output').textContent = text;
    }

    document.getElementById('fileInput').addEventListener('change', function (evt) {
      const file = evt.target.files[0];
      if (!file || !kiriLoaded) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const stlData = e.target.result;

        kiri.loadFile({ name: file.name, buffer: stlData }, function () {
          const device = kiri.api.device.get();

          kiri.api.mode.set("FDM");
          kiri.api.view.hide(); // Hide UI

          // Apply Bambu Lab P1S .20mm standard-ish settings
          kiri.api.config.set({
            sliceHeight: 0.2,
            sliceShells: 2,
            sliceFillSpacing: 2.4, // ~15% infill
            sliceFillType: "hex",
            sliceTopLayers: 3,
            sliceBottomLayers: 3,
            sliceSolidMinArea: 1,
            sliceSupportEnable: false,
            sliceSupportDensity: 0.15,
            sliceSupportOffset: 0.2,
            sliceSupportArea: 1,
            sliceThinWall: true,
            sliceRaftLayers: 0,
            outputClockwise: true,
            outputOriginCenter: false,
            printSpeed: 60,
            printFirstLayerSpeed: 30,
            printLayerRetract: 1.5,
            printRetractSpeed: 5,
            printExtrudeRate: 0.045, // close to Bambu default
            gcodeLaserOn: '',
            gcodeLaserOff: '',
          });

          kiri.api.slice(function (sliced) {
            const layers = kiri.api.widgets[0].slices;
            let totalTime = 0;
            let totalVolume = 0;

            for (const layer of layers) {
              totalTime += layer.time || 0;
              totalVolume += layer.volume || 0;
            }

            const timeMinutes = (totalTime / 60).toFixed(1);
            const filamentMeters = estimateFilament(totalVolume).toFixed(2);

            showOutput(`Estimated print time: ${timeMinutes} minutes\nEstimated filament used: ${filamentMeters} meters`);
          });
        });
      };
      reader.readAsArrayBuffer(file);
    });

    window.addEventListener("load", function () {
      kiri.init({
        onload: () => {
          kiriLoaded = true;
          console.log("✅ Headless Kiri:Moto Loaded");
        },
        container: document.body,
        view: "hide"
      });
    });
  </script>
</body>
</html>
