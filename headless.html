<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Headless Kiri:Moto</title>
  <script src="https://grid.space/js/kiri.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #0f0;
      padding: 20px;
    }
  </style>
</head>
<body>
  <h3>BAMBU MODULE RUNNING</h3>
  <script>
    console.log("✅ Headless Kiri:Moto Loaded");

    function sliceAndReport(fileData) {
      let engine = KIRI;

      engine.init(null, window, function() {
        const settings = engine.conf();

        settings.mode = "FDM";
        settings.device = "Bambu P1S";
        settings.process = Object.assign({}, settings.process, {
          layerHeight: 0.2,
          sliceHeight: 0.2,
          sliceShells: 3,
          sliceTopLayers: 3,
          sliceBottomLayers: 3,
          sliceFillDensity: 0.15,
          sliceFillPattern: "hex",
          printSpeed: 60,
          material: "PLA"
        });

        engine.platform.clear();

        engine.loadFile(fileData, function(vertices) {
          console.log("✅ Model loaded for slicing", vertices);

          engine.platform.compute(function(update) {
            if (update.done) {
              const report = engine.platform.exportData();
              const time = report.time.toFixed(2);
              const filamentMM = report.filament;
              const filamentMeters = (filamentMM / 1000).toFixed(2);

              const message = {
                timeMinutes: time,
                filamentMeters: filamentMeters
              };

              window.parent.postMessage({ type: "slice-result", data: message }, "*");
            }
          });
        });
      });
    }

    window.addEventListener("message", (event) => {
      if (event.data && event.data.type === "slice-file") {
        const stlData = event.data.file;
        sliceAndReport(stlData);
      }
    });
  </script>
</body>
</html>
